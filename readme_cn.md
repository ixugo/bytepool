# BytePool - å¸¦å¼•ç”¨è®¡æ•°çš„é«˜æ€§èƒ½åˆ†å±‚å†…å­˜æ± 

[English](README.md) | ä¸­æ–‡

BytePool æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ Go è¯­è¨€å†…å­˜æ± åº“ï¼Œä¸“ä¸ºè§£å†³"ä¸çŸ¥é“ä½•æ—¶é‡Šæ”¾å†…å­˜"çš„åœºæ™¯è€Œè®¾è®¡ã€‚é€šè¿‡å¼•ç”¨è®¡æ•°æœºåˆ¶ï¼Œè‡ªåŠ¨ç®¡ç†å†…å­˜ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

## ğŸš€ æ ¸å¿ƒäº®ç‚¹

- **å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†**ï¼šæ— éœ€æ‰‹åŠ¨è¿½è¸ªå†…å­˜é‡Šæ”¾æ—¶æœºï¼Œå¼•ç”¨è®¡æ•°å½’é›¶æ—¶è‡ªåŠ¨å›æ”¶
- **åˆ†å±‚å†…å­˜æ± **ï¼šæ”¯æŒå¤šæ¡£ä½å†…å­˜åˆ†é…ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜åˆ†é…æ•ˆç‡
- **é›¶æ‹·è´è®¾è®¡**ï¼šåŸºäº `sync.Pool` ä¼˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´
- **çº¿ç¨‹å®‰å…¨**ï¼šå®Œå…¨å¹¶å‘å®‰å…¨ï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯
- **å†…ç½®ç»Ÿè®¡**ï¼šå®æ—¶ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œæ”¯æŒ expvar é›†æˆ
- **é«˜æ€§èƒ½**ï¼šå†…å­˜åˆ†é…æ€§èƒ½ä¼˜äºç›´æ¥ `make([]byte, size)`ï¼Œç»Ÿè®¡åŠŸèƒ½ä»…å¢åŠ  11ns å¼€é”€

## ğŸ¯ è§£å†³çš„é—®é¢˜

åœ¨ Go å¼€å‘ä¸­ï¼Œç»å¸¸é‡åˆ°ä»¥ä¸‹å†…å­˜ç®¡ç†éš¾é¢˜ï¼š

**ä½•æ—¶ä½¿ç”¨ sync.Poolï¼š**
å¦‚æœä½ çš„åœºæ™¯ä¸­æ˜ç¡®çŸ¥é“ä½•æ—¶é‡Šæ”¾å†…å­˜ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨æ ‡å‡†åº“çš„ `sync.Pool`ã€‚æœ¬åº“ä¹Ÿæä¾›äº†æ³›å‹ç‰ˆæœ¬çš„ `sync.Pool`ï¼ˆ`Pool[T]`ï¼‰ï¼Œå¯ä»¥æä¾›æ›´å¥½çš„ç±»å‹å®‰å…¨æ€§ï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨ã€‚

**ä¼ ç»Ÿæ–¹æ¡ˆçš„å±€é™æ€§ï¼š**
- **æ–¹æ¡ˆä¸€**ï¼šå„åŒ…ç‹¬ç«‹å†…å­˜æ±  â†’ å†…å­˜æµªè´¹ï¼Œå¤šæ¬¡æ‹·è´
- **æ–¹æ¡ˆäºŒ**ï¼šå…±äº«å†…å­˜æ± ä½†ä¸çŸ¥ä½•æ—¶é‡Šæ”¾ â†’ å†…å­˜æ³„æ¼é£é™©

**BytePool çš„è§£å†³æ–¹æ¡ˆï¼š**
å½“ä½ é‡åˆ°"ä¸çŸ¥é“ä½•æ—¶é‡Šæ”¾å†…å­˜"çš„åœºæ™¯æ—¶ï¼ŒBytePool æä¾›äº†å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼š
- å¼•ç”¨è®¡æ•°æœºåˆ¶è‡ªåŠ¨ç®¡ç†å†…å­˜ç”Ÿå‘½å‘¨æœŸ
- åˆ†å±‚æ¶æ„ä¼˜åŒ–ä¸åŒå¤§å°çš„å†…å­˜åˆ†é…
- ç»Ÿè®¡åŠŸèƒ½å¸®åŠ©è¯†åˆ«å†…å­˜ä½¿ç”¨æ¨¡å¼å’Œæ½œåœ¨æ³„æ¼

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
go get -u github.com/ixugo/bytepool
```

### åŸºæœ¬ä½¿ç”¨

```go
package main

import (
    "fmt"
    "github.com/ixugo/bytepool"
)

func main() {
    // åˆ›å»ºåˆ†å±‚å†…å­˜æ± ï¼ˆ128B, 256B, 512B, 1KB, 2KB...ï¼‰
    pool := bytepool.NewPools(bytepool.SizePowerOfTwo())

    // æ–¹å¼ä¸€ï¼šç›´æ¥ä½¿ç”¨ Get/Put
    buf := pool.Get(100) // è·å–è‡³å°‘ 100 å­—èŠ‚çš„å†…å­˜
    // ä½¿ç”¨ buf...
    pool.Put(buf) // æ‰‹åŠ¨é‡Šæ”¾

    // æ–¹å¼äºŒï¼šä½¿ç”¨ Bufferï¼ˆæ¨èï¼‰
    buffer := pool.GetBuffer(200) // è‡ªåŠ¨å¼•ç”¨è®¡æ•°ç®¡ç†
    // ä½¿ç”¨ buffer.Bytes()...
    buffer.Release() // å¼•ç”¨è®¡æ•°-1ï¼Œä¸º0æ—¶è‡ªåŠ¨å›æ”¶
}
```

### å¼•ç”¨è®¡æ•°ç¤ºä¾‹

å¼•ç”¨è®¡æ•°æœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆä¸€ï¼šæ‰‹åŠ¨ç®¡ç†å¼•ç”¨è®¡æ•°**
```go
// åˆ›å»º Buffer
buffer := pool.GetBuffer(1024)

// å¢åŠ å¼•ç”¨
buffer.Retain() // å¼•ç”¨è®¡æ•° = 2

// åœ¨ä¸åŒ goroutine ä¸­ä½¿ç”¨
go func() {
    defer buffer.Release() // å¼•ç”¨è®¡æ•°-1
    // ä½¿ç”¨ buffer...
}()

// ä¸» goroutine é‡Šæ”¾
buffer.Release() // å¼•ç”¨è®¡æ•°-1ï¼Œæ­¤æ—¶ä¸º0ï¼Œè‡ªåŠ¨å›æ”¶åˆ°æ± ä¸­
```

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Bytes() è‡ªåŠ¨ç®¡ç†**
```go
// åˆ›å»º Buffer
buffer := pool.GetBuffer(1024)

// ä½¿ç”¨ Bytes() æ–¹æ³•ï¼Œè‡ªåŠ¨å¢åŠ å¼•ç”¨è®¡æ•°å¹¶è¿”å›é‡Šæ”¾å‡½æ•°
data, release := buffer.Bytes()

// åœ¨ä¸åŒ goroutine ä¸­ä½¿ç”¨
go func() {
    defer release() // è‡ªåŠ¨é‡Šæ”¾å¼•ç”¨
    // ä½¿ç”¨ data...
}()

// ä¸» goroutine é‡Šæ”¾
buffer.Release() // é‡Šæ”¾åˆå§‹å¼•ç”¨
```

## ğŸ“Š ç»Ÿè®¡åŠŸèƒ½

BytePool å†…ç½®å¼ºå¤§çš„ç»Ÿè®¡åŠŸèƒ½ï¼Œå¸®åŠ©ç›‘æ§å’Œä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼š

### é€šè¿‡ expvar æŸ¥çœ‹ç»Ÿè®¡æ•°æ®

```go
// å¯ç”¨ expvar ç»Ÿè®¡
pool.Expvar("myapp_")

// ä½¿ç”¨ Go é»˜è®¤çš„ http æœåŠ¡æ—¶ï¼Œå¯ä»¥è®¿é—® http://localhost:6060/debug/vars æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
// æˆ–åœ¨ä»£ç ä¸­è·å–
stats := pool.GetPoolStats()
```

### ç»Ÿè®¡å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `pools` | `map[int]map[string]int64` | å„æ¡£ä½çš„è¯¦ç»†ç»Ÿè®¡ï¼Œkeyä¸ºæ¡£ä½å¤§å° |
| `pools[size].get` | `int64` | è¯¥æ¡£ä½çš„ get æ“ä½œæ¬¡æ•° |
| `pools[size].put` | `int64` | è¯¥æ¡£ä½çš„ put æ“ä½œæ¬¡æ•° |
| `discarded` | `int64` | è¶…è¿‡æœ€å¤§æ¡£ä½è¢«ä¸¢å¼ƒçš„åˆ†é…æ¬¡æ•° |
| `total_get` | `int64` | æ€»çš„æœ‰æ•ˆ get æ“ä½œæ•°é‡ï¼ˆä»…ç»Ÿè®¡å†…å­˜æ± åˆ†é…ï¼‰ |
| `total_put` | `int64` | æ€»çš„æœ‰æ•ˆ put æ“ä½œæ•°é‡ï¼ˆä»…ç»Ÿè®¡å†…å­˜æ± å›æ”¶ï¼‰ |
| `recent_lengths` | `[]int` | æœ€è¿‘ 256 ä¸ª get æ“ä½œçš„è¯·æ±‚é•¿åº¦ï¼ˆç¯å½¢é˜Ÿåˆ—ï¼‰ |

### å†…å­˜æ³„æ¼æ£€æµ‹

é€šè¿‡æ¯”è¾ƒ `total_get` å’Œ `total_put` å¯ä»¥æ£€æµ‹æ½œåœ¨çš„å†…å­˜æ³„æ¼ï¼š

- `total_get > total_put`ï¼šå­˜åœ¨æœªé‡Šæ”¾çš„å†…å­˜
- `total_get = total_put`ï¼šå†…å­˜åˆ†é…å¹³è¡¡
- ç›‘æ§ `recent_lengths` å¯åˆ†æå†…å­˜åˆ†é…æ¨¡å¼

## ğŸ“š API æ–‡æ¡£

### æ ¸å¿ƒç±»å‹

#### BytePool

ä¸»è¦çš„å†…å­˜æ± ç±»å‹ï¼Œç®¡ç†å¤šä¸ªæ¡£ä½çš„å†…å­˜åˆ†é…ã€‚

#### Buffer

å¸¦å¼•ç”¨è®¡æ•°çš„å†…å­˜ç¼“å†²åŒºï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚

#### Pool[T]

æ³›å‹ç‰ˆæœ¬çš„ `sync.Pool`ï¼Œæä¾›ç±»å‹å®‰å…¨çš„å¯¹è±¡æ± ã€‚å¦‚æœä½ æ˜ç¡®çŸ¥é“ä½•æ—¶é‡Šæ”¾å†…å­˜ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»å‹è€Œä¸æ˜¯ BytePoolã€‚

### åˆ›å»ºå‡½æ•°

#### `NewPools(sizes []int) *BytePool`

åˆ›å»ºæ–°çš„åˆ†å±‚å†…å­˜æ± ã€‚

**å‚æ•°ï¼š**
- `sizes`: å†…å­˜æ¡£ä½æ•°ç»„ï¼Œå¿…é¡»ä¸ºæ­£æ•°ä¸”æœ‰åº

**è¿”å›ï¼š**
- `*BytePool`: å†…å­˜æ± å®ä¾‹

**ç¤ºä¾‹ï¼š**
```go
// ä½¿ç”¨é¢„å®šä¹‰çš„ 2 çš„å¹‚æ¬¡æ–¹æ¡£ä½
pool := bytepool.NewPools(bytepool.SizePowerOfTwo())

// è‡ªå®šä¹‰æ¡£ä½
pool := bytepool.NewPools([]int{128, 512, 2048})
```

#### `SizePowerOfTwo() []int`

è¿”å› 2 çš„å¹‚æ¬¡æ–¹æ¡£ä½åºåˆ—ï¼ˆ128B åˆ° 2MBï¼‰ã€‚

#### `SizeStream() []int`

è¿”å›é€‚åˆæµå¤„ç†çš„æ¡£ä½åºåˆ—ã€‚

#### `NewPool[T any](fn func() T) *Pool[T]`

åˆ›å»ºæ–°çš„æ³›å‹å¯¹è±¡æ± ã€‚

**å‚æ•°ï¼š**
- `fn`: åˆ›å»ºæ–°å¯¹è±¡çš„å‡½æ•°

**è¿”å›ï¼š**
- `*Pool[T]`: æ³›å‹å¯¹è±¡æ± å®ä¾‹

**ç¤ºä¾‹ï¼š**
```go
// åˆ›å»ºå­—ç¬¦ä¸²æ± 
stringPool := bytepool.NewPool(func() string { return "" })

// åˆ›å»ºè‡ªå®šä¹‰ç»“æ„ä½“æ± 
type MyStruct struct { Data []byte }
structPool := bytepool.NewPool(func() *MyStruct {
    return &MyStruct{Data: make([]byte, 1024)}
})
```

### å†…å­˜åˆ†é…æ–¹æ³•

#### `(*BytePool) Get(length int) []byte`

ä»æ± ä¸­è·å–æŒ‡å®šé•¿åº¦çš„å­—èŠ‚åˆ‡ç‰‡ã€‚

**å‚æ•°ï¼š**
- `length`: éœ€è¦çš„å­—èŠ‚æ•°

**è¿”å›ï¼š**
- `[]byte`: å­—èŠ‚åˆ‡ç‰‡ï¼Œé•¿åº¦ä¸º lengthï¼Œå®¹é‡å¯èƒ½æ›´å¤§

#### `(*BytePool) Put(buf []byte)`

å°†å­—èŠ‚åˆ‡ç‰‡æ”¾å›æ± ä¸­ã€‚

**å‚æ•°ï¼š**
- `buf`: è¦å›æ”¶çš„å­—èŠ‚åˆ‡ç‰‡

#### `(*BytePool) GetBuffer(length int) *Buffer`

è·å–å¸¦å¼•ç”¨è®¡æ•°çš„ Bufferã€‚

**å‚æ•°ï¼š**
- `length`: éœ€è¦çš„å­—èŠ‚æ•°

**è¿”å›ï¼š**
- `*Buffer`: Buffer å®ä¾‹ï¼Œåˆå§‹å¼•ç”¨è®¡æ•°ä¸º 1

#### `(*BytePool) ReleaseBuffer(buf *Buffer)`

é‡Šæ”¾ Bufferï¼ˆç­‰åŒäº `buf.Release()`ï¼‰ã€‚

### Buffer æ–¹æ³•

#### `(*Buffer) Bytes() ([]byte, func())`

è·å– Buffer çš„å­—èŠ‚åˆ‡ç‰‡ï¼Œè‡ªåŠ¨å¢åŠ å¼•ç”¨è®¡æ•°ã€‚

**è¿”å›ï¼š**
- `[]byte`: å­—èŠ‚åˆ‡ç‰‡
- `func()`: é‡Šæ”¾å‡½æ•°ï¼Œè°ƒç”¨æ—¶è‡ªåŠ¨å‡å°‘å¼•ç”¨è®¡æ•°

#### `(*Buffer) Retain() *Buffer`

å¢åŠ å¼•ç”¨è®¡æ•°ã€‚

**è¿”å›ï¼š**
- `*Buffer`: è¿”å›è‡ªèº«ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨

#### `(*Buffer) Release()`

å‡å°‘å¼•ç”¨è®¡æ•°ï¼Œä¸º 0 æ—¶è‡ªåŠ¨å›æ”¶åˆ°æ± ä¸­ã€‚

#### `(*Buffer) RefCount() int32`

è·å–å½“å‰å¼•ç”¨è®¡æ•°ã€‚

### ç»Ÿè®¡æ–¹æ³•

#### `(*BytePool) GetPoolStats() map[string]interface{}`

è·å–è¯¦ç»†çš„æ± ç»Ÿè®¡ä¿¡æ¯ã€‚

#### `(*BytePool) GetDiscardedCount() int64`

è·å–è¢«ä¸¢å¼ƒçš„åˆ†é…æ¬¡æ•°ã€‚

#### `(*BytePool) GetAvailableSizes() []int`

è·å–æ‰€æœ‰å¯ç”¨çš„æ¡£ä½å¤§å°ã€‚

#### `(*BytePool) Expvar(prefix string) *BytePool`

å¯ç”¨ expvar ç»Ÿè®¡ï¼Œä½¿ç”¨æŒ‡å®šå‰ç¼€ã€‚

**å‚æ•°ï¼š**
- `prefix`: ç»Ÿè®¡å˜é‡çš„å‰ç¼€

**è¿”å›ï¼š**
- `*BytePool`: è¿”å›è‡ªèº«ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨

### Pool[T] æ–¹æ³•

#### `(*Pool[T]) Get() T`

ä»æ± ä¸­è·å–å¯¹è±¡ã€‚

**è¿”å›ï¼š**
- `T`: æ± ä¸­çš„å¯¹è±¡æˆ–æ–°åˆ›å»ºçš„å¯¹è±¡

#### `(*Pool[T]) Put(x T)`

å°†å¯¹è±¡æ”¾å›æ± ä¸­ã€‚

**å‚æ•°ï¼š**
- `x`: è¦æ”¾å›æ± ä¸­çš„å¯¹è±¡

**ç¤ºä¾‹ï¼š**
```go
pool := bytepool.NewPool(func() []byte { return make([]byte, 1024) })

// è·å–å¯¹è±¡
buf := pool.Get()
// ä½¿ç”¨ buf...

// æ”¾å›æ± ä¸­
pool.Put(buf)
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰æ¡£ä½é…ç½®

æ ¹æ®åº”ç”¨ç‰¹ç‚¹é…ç½®åˆé€‚çš„æ¡£ä½ï¼š

```go
// é’ˆå¯¹å°å¯¹è±¡ä¼˜åŒ–
smallPool := bytepool.NewPools([]int{64, 128, 256, 512})

// é’ˆå¯¹å¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–
largePool := bytepool.NewPools([]int{4096, 16384, 65536, 262144})
```

### ä½¿ç”¨æ³›å‹å¯¹è±¡æ± 

å½“ä½ æ˜ç¡®çŸ¥é“ä½•æ—¶é‡Šæ”¾å†…å­˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ³›å‹ Pool[T]ï¼š

```go
// åˆ›å»ºç¼“å†²åŒºæ± 
bufferPool := bytepool.NewPool(func() *bytes.Buffer {
    return &bytes.Buffer{}
})

// ä½¿ç”¨
buf := bufferPool.Get()
buf.Reset() // æ¸…ç©ºç¼“å†²åŒº
buf.WriteString("Hello, World!")
// ä½¿ç”¨å®Œæ¯•åæ”¾å›
bufferPool.Put(buf)

// åˆ›å»ºè‡ªå®šä¹‰ç»“æ„ä½“æ± 
type Request struct {
    ID   int
    Data []byte
}

requestPool := bytepool.NewPool(func() *Request {
    return &Request{Data: make([]byte, 1024)}
})
```

### æ€§èƒ½ç›‘æ§

```go
// å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
go func() {
    ticker := time.NewTicker(time.Minute)
    for range ticker.C {
        stats := pool.GetPoolStats()
        totalGet := stats["total_get"].(int64)
        totalPut := stats["total_put"].(int64)

        if totalGet != totalPut {
            log.Printf("å†…å­˜æ³„æ¼è­¦å‘Š: get=%d, put=%d", totalGet, totalPut)
        }
    }
}()
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | BytePool | ç›´æ¥åˆ†é… | æ€§èƒ½æå‡ |
|------|----------|----------|----------|
| å°å¯¹è±¡åˆ†é… (128B) | 88.94 ns/op | 532.5 ns/op | ~6x |
| å¤§å¯¹è±¡åˆ†é… (64KB) | 761.0 ns/op | - | - |
| ç»Ÿè®¡å¼€é”€ | +11 ns/op | - | æå° |

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
